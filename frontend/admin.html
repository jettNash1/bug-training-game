<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="QA Learning Hub Admin Panel - Manage users and track progress">
    <title>Quiz Admin Panel</title>
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
    <link rel="stylesheet" href="styles.css">
    <script type="module" src="./config.js"></script>
    <script type="module" src="./api-service.js"></script>
    <script type="module" src="./QuizUser.js"></script>
    <script type="module" src="./quiz-helper.js"></script>
    <script type="module" src="./login.js"></script>
    <script type="module" src="./auth.js"></script>
    <script type="module">
        import { APIService } from './api-service.js';
        import { QuizUser } from './QuizUser.js';
        
        const apiService = new APIService();
        let users = [];
        let userScores = new Map();
        let statistics = {
            totalUsers: 0,
            activeToday: 0,
            averageCompletion: 0
        };

        // Quiz types configuration
        const quizTypes = {
            'communication': 'Communication',
            'initiative': 'Initiative',
            'time-management': 'Time Management',
            'tester-mindset': 'Tester Mindset',
            'risk-analysis': 'Risk Analysis',
            'risk-management': 'Risk Management',
            'non-functional': 'Non-functional Testing',
            'test-support': 'Test Support',
            'issue-verification': 'Issue Verification',
            'build-verification': 'Build Verification',
            'issue-tracking': 'Issue Tracking Tools',
            'raising-tickets': 'Raising Tickets',
            'reports': 'Reports',
            'CMS-Testing': 'CMS Testing'
        };

        async function handleAdminLogin() {
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;

            try {
                const response = await apiService.login(username, password);
                if (response.success) {
                    showAdminDashboard();
                } else {
                    showError('Invalid admin credentials');
                }
            } catch (error) {
                console.error('Login error:', error);
                showError('Login failed. Please try again.');
            }
        }

        async function handleAdminLogout() {
            try {
                localStorage.removeItem('token');
                localStorage.removeItem('refreshToken');
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-notification';
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 5000);
        }

        async function loadUserProgress(username) {
            const scores = [];
            
            for (const [quizId, _] of Object.entries(quizTypes)) {
                try {
                    const progress = await apiService.getQuizProgress(quizId, username);
                    if (progress && progress.data) {
                        const questionsAnswered = progress.data.questionHistory ? progress.data.questionHistory.length : 0;
                        const score = Math.round((questionsAnswered / 15) * 100);
                        scores.push({
                            quizName: quizId,
                            score: score,
                            questionsAnswered: questionsAnswered,
                            completedAt: progress.data.lastUpdated || new Date().toISOString(),
                            lastActive: progress.data.lastUpdated
                        });
                    }
                } catch (error) {
                    console.error(`Error loading progress for ${quizId}:`, error);
                }
            }
            
            return scores;
        }

        async function resetUserProgress(username, quizName) {
            try {
                const response = await apiService.fetchWithAuth(
                    `${apiService.baseUrl}/users/${username}/reset-quiz/${quizName}`,
                    { method: 'POST' }
                );
                
                if (response.ok) {
                    showError(`Successfully reset ${quizName} for ${username}`);
                    await updateDashboard(); // Refresh the dashboard
                } else {
                    showError('Failed to reset quiz progress');
                }
            } catch (error) {
                console.error('Error resetting progress:', error);
                showError('Failed to reset quiz progress');
            }
        }

        function updateStatistics() {
            const today = new Date().toISOString().split('T')[0];
            let totalCompletion = 0;
            let activeUsers = new Set();

            users.forEach(user => {
                const scores = userScores.get(user.username) || [];
                if (scores.some(score => score.lastActive?.startsWith(today))) {
                    activeUsers.add(user.username);
                }

                const userCompletion = scores.reduce((sum, score) => sum + score.score, 0) / Object.keys(quizTypes).length;
                totalCompletion += userCompletion;
            });

            statistics = {
                totalUsers: users.length,
                activeToday: activeUsers.size,
                averageCompletion: users.length ? Math.round(totalCompletion / users.length) : 0
            };

            // Update statistics display
            document.getElementById('totalUsers').textContent = statistics.totalUsers;
            document.getElementById('activeUsers').textContent = statistics.activeToday;
            document.getElementById('averageCompletion').textContent = `${statistics.averageCompletion}%`;
        }

        async function showUserDetails(username) {
            const scores = userScores.get(username) || [];
            const overlay = document.createElement('div');
            overlay.className = 'user-details-overlay';
            
            const content = document.createElement('div');
            content.className = 'user-details-content';
            
            content.innerHTML = `
                <div class="user-details-header">
                    <h2>${username}'s Progress</h2>
                    <button class="close-button" onclick="this.closest('.user-details-overlay').remove()">Ã—</button>
                </div>
                <div class="user-details-body">
                    <div class="quiz-progress-list">
                        ${Object.entries(quizTypes).map(([quizId, displayName]) => {
                            const result = scores.find(s => s.quizName === quizId);
                            return `
                                <div class="quiz-progress-item">
                                    <div class="quiz-info">
                                        <h3>${displayName}</h3>
                                        <div class="progress-details">
                                            <span class="score">${result ? result.score : 0}% Complete</span>
                                            ${result ? `
                                                <span class="questions">Questions: ${result.questionsAnswered}/15</span>
                                                <span class="last-active">Last Active: ${new Date(result.lastActive).toLocaleDateString()}</span>
                                            ` : '<span class="not-started">Not Started</span>'}
                                        </div>
                                    </div>
                                    <button class="reset-button" onclick="window.resetUserProgress('${username}', '${quizId}')">
                                        Reset Progress
                                    </button>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            
            overlay.appendChild(content);
            document.body.appendChild(overlay);
        }

        async function updateDashboard() {
            try {
                // Get all users
                const response = await apiService.fetchWithAuth(`${apiService.baseUrl}/users`);
                const data = await response.json();
                users = data.users || [];

                // Load progress for each user
                for (const user of users) {
                    const scores = await loadUserProgress(user.username);
                    userScores.set(user.username, scores);
                }

                updateStatistics();

                const usersList = document.getElementById('usersList');
                const searchInput = document.getElementById('userSearch').value.toLowerCase();
                const sortBy = document.getElementById('sortBy').value;
                
                let filteredUsers = users.filter(user => 
                    user.username.toLowerCase().includes(searchInput)
                );

                // Sort users
                filteredUsers.sort((a, b) => {
                    const scoresA = userScores.get(a.username) || [];
                    const scoresB = userScores.get(b.username) || [];
                    
                    switch (sortBy) {
                        case 'username-asc':
                            return a.username.localeCompare(b.username);
                        case 'username-desc':
                            return b.username.localeCompare(a.username);
                        case 'progress-high':
                            return getAverageScore(scoresB) - getAverageScore(scoresA);
                        case 'progress-low':
                            return getAverageScore(scoresA) - getAverageScore(scoresB);
                        case 'last-active':
                            return getLastActiveDate(scoresB) - getLastActiveDate(scoresA);
                        default:
                            return 0;
                    }
                });

                usersList.innerHTML = '';

                filteredUsers.forEach(user => {
                    const scores = userScores.get(user.username) || [];
                    const card = document.createElement('div');
                    card.className = 'user-card';

                    const totalScore = getAverageScore(scores);
                    const lastActive = getLastActiveDate(scores);

                    card.innerHTML = `
                        <div class="user-header">
                            <h4>${user.username}</h4>
                            <div class="user-stats">
                                <div class="total-score">Overall Progress: ${totalScore.toFixed(1)}%</div>
                                <div class="last-active">Last Active: ${lastActive ? new Date(lastActive).toLocaleDateString() : 'Never'}</div>
                            </div>
                        </div>
                        <button class="view-details-btn" onclick="window.showUserDetails('${user.username}')">
                            View Details
                        </button>
                    `;

                    usersList.appendChild(card);
                });
            } catch (error) {
                console.error('Error updating dashboard:', error);
                showError('Failed to update dashboard');
            }
        }

        function getAverageScore(scores) {
            if (!scores || scores.length === 0) return 0;
            const sum = scores.reduce((acc, result) => acc + (result.score || 0), 0);
            return sum / Object.keys(quizTypes).length;
        }

        function getLastActiveDate(scores) {
            if (!scores || scores.length === 0) return 0;
            return Math.max(...scores.map(result => 
                result.lastActive ? new Date(result.lastActive).getTime() : 0
            ));
        }

        // Initialize dashboard when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('token');
            if (token) {
                showAdminDashboard();
            }

            // Add event listeners
            document.getElementById('userSearch').addEventListener('input', debounce(updateDashboard, 300));
            document.getElementById('sortBy').addEventListener('change', updateDashboard);
        });

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Expose functions to window for onclick handlers
        window.handleAdminLogin = handleAdminLogin;
        window.handleAdminLogout = handleAdminLogout;
        window.showUserDetails = showUserDetails;
        window.resetUserProgress = resetUserProgress;
    </script>
</head>
<body>
    <header class="app-header" role="banner">
        <div class="logo">
            <img src="assets/zoonou-logo.svg" alt="Zoonou Logo" width="32" height="32">
            <h1>Admin Dashboard</h1>
        </div>
        <nav class="admin-nav" role="navigation">
            <a href="index.html" class="nav-link">Return to Learning Hub</a>
            <button onclick="handleAdminLogout()" class="logout-btn">Logout</button>
        </nav>
    </header>

    <main class="admin-container" role="main">
        <!-- Login Form -->
        <section id="adminLoginForm" class="admin-login-section" aria-labelledby="login-header">
            <h2 id="login-header">Admin Login</h2>
            <form class="form-group" onsubmit="event.preventDefault(); handleAdminLogin();">
                <div class="form-field">
                    <label for="adminUsername">Admin Username</label>
                    <input type="text" 
                           id="adminUsername" 
                           name="username"
                           required
                           aria-required="true"
                           autocomplete="username">
                </div>
                <div class="form-field">
                    <label for="adminPassword">Admin Password</label>
                    <input type="password" 
                           id="adminPassword" 
                           name="password"
                           required
                           aria-required="true"
                           autocomplete="current-password">
                </div>
                <button type="submit" class="submit-btn">Login</button>
            </form>
        </section>

        <!-- Admin Dashboard -->
        <section id="adminDashboard" class="admin-dashboard hidden" aria-labelledby="dashboard-header">
            <!-- Statistics Overview -->
            <div class="statistics-panel">
                <div class="stat-card">
                    <h3>Total Users</h3>
                    <div id="totalUsers" class="stat-value">0</div>
                </div>
                <div class="stat-card">
                    <h3>Active Today</h3>
                    <div id="activeUsers" class="stat-value">0</div>
                </div>
                <div class="stat-card">
                    <h3>Average Completion</h3>
                    <div id="averageCompletion" class="stat-value">0%</div>
                </div>
            </div>

            <!-- User Management -->
            <div class="user-management-panel">
                <div class="panel-header">
                    <h2>User Management</h2>
                    <div class="search-controls">
                        <div class="search-field">
                            <label for="userSearch">Search Users</label>
                            <input type="text" 
                                   id="userSearch" 
                                   placeholder="Search by username..."
                                   aria-label="Search users">
                        </div>
                        <div class="sort-field">
                            <label for="sortBy">Sort By</label>
                            <select id="sortBy" aria-label="Sort users by">
                                <option value="username-asc">Username (A-Z)</option>
                                <option value="username-desc">Username (Z-A)</option>
                                <option value="progress-high">Progress (High to Low)</option>
                                <option value="progress-low">Progress (Low to High)</option>
                                <option value="last-active">Last Active</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="usersList" class="users-list">
                    <!-- User cards will be populated here -->
                </div>
            </div>
        </section>
    </main>
</body>
</html> 
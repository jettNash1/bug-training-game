<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QA Learning Hub</title>
    <link rel="stylesheet" href="styles.css">
    <script src="QuizUser.js"></script>
    <script src="api-service.js"></script>
    <script src="login.js"></script>
    <script src="login-ui.js"></script>
    <script src="quiz-helper.js"></script>
</head>
<body>
    <div id="loginSection" class="login-section">
        <h2>Welcome to Quiz Platform</h2>
        <div id="loginForm">
            <div class="form-tabs">
                <button onclick="showLoginForm()" class="tab-btn active" id="loginTab">Login</button>
                <button onclick="showRegisterForm()" class="tab-btn" id="registerTab">Register</button>
            </div>
            
            <div id="loginFormContent">
                <input type="text" id="loginUsername" placeholder="Username" aria-label="Username">
                <input type="password" id="loginPassword" placeholder="Password" aria-label="Password">
                <button onclick="handleLogin()" aria-label="Login">Login</button>
            </div>
            
            <div id="registerFormContent" style="display: none;">
                <input type="text" id="registerUsername" placeholder="Choose Username" aria-label="Choose Username">
                <input type="password" id="registerPassword" placeholder="Choose Password" aria-label="Choose Password">
                <button onclick="handleRegister()" aria-label="Register">Register</button>
            </div>
        </div>
        
        <div id="userInfo" style="display: none;">
            <p>Welcome, <span id="userDisplay"></span>!</p>
            <div id="quizProgress"></div>
            <button onclick="UserManager.logout()" aria-label="Logout">Logout</button>
        </div>
    </div>

    <script>
        async function updateUIForLoggedInUser(user) {
            try {
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('userInfo').style.display = 'block';
                document.getElementById('userDisplay').textContent = user.username;
                
                // Make sure we have the latest data
                const quizResults = await user.loadUserData();
                const progressDiv = document.getElementById('quizProgress');
                progressDiv.innerHTML = '';
                
                if (Array.isArray(quizResults) && quizResults.length > 0) {
                    progressDiv.innerHTML = quizResults.map(result => {
                        // Format quiz name to be more readable
                        const quizName = result.quizName
                            .split('-')
                            .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                            .join(' ');
                        const score = result.score || 0;
                        return `
                            <div class="quiz-result">
                                <span class="quiz-name">${quizName}</span>
                                <span class="quiz-score">${score}%</span>
                            </div>
                        `;
                    }).join('');
                } else {
                    progressDiv.innerHTML = '<p>No quiz results yet. Try taking a quiz!</p>';
                }
            } catch (error) {
                console.error('Error updating UI:', error);
                alert('There was an error loading your quiz results. Please try again.');
            }
        }

        async function handleLogin() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const user = await UserManager.login(username, password);
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('userInfo').style.display = 'block';
                document.getElementById('userDisplay').textContent = username;
                await updateUIForLoggedInUser(user);
            } catch (error) {
                alert(error.message || 'Login failed. Please try again.');
            }
        }

        async function handleRegister() {
            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;
            
            try {
                const user = await UserManager.register(username, password);
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('userInfo').style.display = 'block';
                document.getElementById('userDisplay').textContent = username;
                await updateUIForLoggedInUser(user);
            } catch (error) {
                alert(error.message || 'Registration failed. Please try again.');
            }
        }

        // Check if user is already logged in
        (async function() {
            const currentUser = localStorage.getItem('currentUser');
            const token = localStorage.getItem('token');
            
            if (currentUser && token) {
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('userInfo').style.display = 'block';
                document.getElementById('userDisplay').textContent = currentUser;
                
                try {
                    const user = new QuizUser(currentUser);
                    await updateUIForLoggedInUser(user);
                } catch (error) {
                    console.error('Error loading user data:', error);
                }
            }
        })();
    </script>

    <div class="main-container">
        <h1>QA Learning Hub</h1>
        <p>Select a category and quiz to begin your learning journey</p>

        <div class="categories-container">
            <!-- Personal Organisation -->
            <div class="category-dropdown">
                <button class="category-btn">Personal Organisation</button>
                <div class="dropdown-content">
                    <a href="pages/communication-quiz.html">Communication Skills Quiz</a>
                    <a href="pages/tester-mindset-quiz.html">Tester Mindset Quiz</a>
                    <a href="pages/time-management-quiz.html">Time Management Quiz</a>
                </div>
            </div>

            <!-- Risk -->
            <div class="category-dropdown">
                <button class="category-btn">Risk</button>
                <div class="dropdown-content">
                    <a href="pages/risk-analysis.html">Risk Analysis Quiz</a>
                    <a href="pages/risk-management.html">Risk Management Quiz</a>
                </div>
            </div>

            <!-- Test Execution -->
            <div class="category-dropdown">
                <button class="category-btn">Test Execution</button>
                <div class="dropdown-content">
                    <a href="pages/non-functional-quiz.html">Risk Analysis Quiz</a>
                    <a href="pages/test-support.html">Test Support Quiz</a>
                    <a href="pages/issue-verification.html">Issue Verification Quiz</a>
                </div>
            </div>

            <!-- Tickets and Tracking -->
            <div class="category-dropdown">
                <button class="category-btn">Tickets and Tracking</button>
                <div class="dropdown-content">
                    <a href="pages/issue-tracking-tools.html">Issue Tracking Tools Quiz</a>
                    <a href="pages/raising-tickets.html">Raising Tickets Quiz</a>
                    <a href="pages/reports-quiz.html">Reports Quiz</a>
                </div>
            </div>

            <!-- Misc -->
            <div class="category-dropdown">
                <button class="category-btn">Misc</button>
                <div class="dropdown-content">
                    <a href="pages/initiative-quiz.html">Initiative Quiz</a>
                </div>
            </div>

            <!-- A11y -->
            <div class="category-dropdown">
                <button class="category-btn">Accessibility Training</button>
                <div class="dropdown-content">
                    <p class="coming-soon">Quizzes coming soon!</p>
                </div>
            </div>
        </div>
    </div>

    <div class="admin-link">
        <a href="admin.html" class="admin-button">Admin Panel</a>
    </div>
</body>
</html>